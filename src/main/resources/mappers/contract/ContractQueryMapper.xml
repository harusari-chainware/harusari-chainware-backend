<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.harusari.chainware.contract.query.mapper.VendorProductContractMapper">

    <resultMap id="VendorContractResultMap" type="com.harusari.chainware.contract.query.dto.response.VendorProductContractDto">
        <result property="contractId" column="contract_id" />
        <result property="contractPrice" column="contract_price" />
        <result property="minOrderQty" column="min_order_qty" />
        <result property="leadTime" column="lead_time" />
        <result property="contractStartDate" column="contract_start_date" />
        <result property="contractEndDate" column="contract_end_date" />
        <result property="contractStatus" column="contract_status" />
        <result property="createdAt" column="created_at" />
        <result property="modifiedAt" column="modified_at" />

        <result property="vendorId" column="vendor_id" />

        <result property="productId" column="product_id" />
        <result property="productName" column="product_name" />
        <result property="basePrice" column="base_price" />
        <result property="unitQuantity" column="unit_quantity" />
        <result property="unitSpec" column="unit_spec" javaType="java.lang.String"/>
        <result property="storeType" column="store_type" />

        <result property="topCategoryId" column="top_category_id" />
        <result property="topCategoryName" column="top_category_name" />

        <result property="categoryId" column="category_id" />
        <result property="categoryName" column="category_name" />
    </resultMap>

    <select id="findVendorProductContracts" resultType="com.harusari.chainware.contract.query.dto.response.VendorProductContractDto">
        SELECT
        c.contract_id,
        c.contract_price,
        c.min_order_qty,
        c.lead_time,
        c.contract_start_date,
        c.contract_end_date,
        c.contract_status,
        c.created_at,
        c.modified_at,

        v.vendor_id,

        p.product_id,
        p.product_name,
        p.base_price,
        p.unit_quantity,
        p.unit_spec,
        p.store_type,

        tc.category_id AS top_category_id,
        tc.category_name AS top_category_name,

        cgy.category_id,
        cgy.category_name
        FROM contract c
        JOIN vendor v ON c.vendor_id = v.vendor_id
        JOIN product p ON c.product_id = p.product_id
        JOIN category cgy ON p.category_id = cgy.category_id
        JOIN category tc ON cgy.top_category_id = tc.category_id
        WHERE c.is_deleted = 0

        <if test="isManager">
            <if test="request.vendorId != null">
                AND c.vendor_id = #{request.vendorId}
            </if>
        </if>
        <if test="!isManager">
            AND c.vendor_id = #{vendorId}
        </if>

        ORDER BY c.contract_id DESC
        LIMIT #{request.size}
        OFFSET #{request.offset}
    </select>

    <select id="countVendorProductContracts" resultType="long">
        SELECT COUNT(*)
        FROM contract c
        WHERE c.is_deleted = 0
        <if test="isManager">
            <if test="request.vendorId != null">
                AND c.vendor_id = #{request.vendorId}
            </if>
        </if>
        <if test="!isManager">
            AND c.vendor_id = #{vendorId}
        </if>
    </select>

    <select id="findVendorIdByMemberId" resultType="long">
        SELECT vendor_id
        FROM vendor
        WHERE member_id = #{memberId}
        LIMIT 1
    </select>

</mapper>