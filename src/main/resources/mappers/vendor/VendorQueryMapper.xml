<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.harusari.chainware.vendor.query.mapper.VendorQueryMapper">

    <select id="findVendors" resultType="com.harusari.chainware.vendor.query.dto.VendorListDto"
            parameterType="com.harusari.chainware.vendor.query.dto.VendorSearchRequestDto">
        SELECT
        v.vendor_id AS vendorId,
        v.vendor_name AS vendorName,
        v.vendor_type AS vendorType,
        v.vendor_zipcode,
        v.vendor_address_road,
        v.vendor_address_detail,
        v.vendor_status AS vendorStatus,
        v.vendor_end_date AS vendorEndDate
        FROM vendor v
        WHERE 1=1
        <if test="vendorName != null and vendorName != ''">
            AND v.vendor_name LIKE CONCAT('%', #{vendorName}, '%')
        </if>
        <if test="vendorAddress != null and vendorAddress != ''">
            AND (
            v.vendor_zipcode LIKE CONCAT('%', #{vendorAddress}, '%')
            OR v.vendor_address_road LIKE CONCAT('%', #{vendorAddress}, '%')
            OR v.vendor_address_detail LIKE CONCAT('%', #{vendorAddress}, '%')
            )
        </if>
        <if test="vendorType != null">
            AND v.vendor_type = #{vendorType}
        </if>
        <if test="vendorStatus != null">
            AND v.vendor_status = #{vendorStatus}
        </if>
        <if test="baseDate != null">
            <![CDATA[
        AND (
            (v.vendor_start_date IS NULL OR v.vendor_start_date <= #{baseDate})
            AND (v.vendor_end_date IS NULL OR v.vendor_end_date >= #{baseDate})
        )
        ]]>
        </if>
        ORDER BY v.vendor_id DESC
        LIMIT #{limit}
        OFFSET #{offset}
    </select>

    <select id="countVendors" resultType="long"
            parameterType="com.harusari.chainware.vendor.query.dto.VendorSearchRequestDto">
        SELECT COUNT(*)
        FROM vendor v
        WHERE 1=1
        <if test="vendorName != null and vendorName != ''">
            AND v.vendor_name LIKE CONCAT('%', #{vendorName}, '%')
        </if>
        <if test="vendorAddress != null and vendorAddress != ''">
            AND (
            v.vendor_zipcode LIKE CONCAT('%', #{vendorAddress}, '%')
            OR v.vendor_address_road LIKE CONCAT('%', #{vendorAddress}, '%')
            OR v.vendor_address_detail LIKE CONCAT('%', #{vendorAddress}, '%')
            )
        </if>
        <if test="vendorType != null">
            AND v.vendor_type = #{vendorType}
        </if>
        <if test="vendorStatus != null">
            AND v.vendor_status = #{vendorStatus}
        </if>
        <if test="baseDate != null">
            <![CDATA[
        AND (
            (v.vendor_start_date IS NULL OR v.vendor_start_date <= #{baseDate})
            AND (v.vendor_end_date IS NULL OR v.vendor_end_date >= #{baseDate})
        )
        ]]>
        </if>
    </select>

    <resultMap id="VendorDetailResultMap" type="com.harusari.chainware.vendor.query.dto.VendorDetailDto">
        <id property="vendorId" column="vendor_id"/>
        <result property="memberId" column="member_id"/>
        <result property="name" column="member_name"/>
        <result property="phoneNumber" column="member_phone"/>
        <result property="vendorName" column="vendor_name"/>
        <result property="vendorType" column="vendor_type" javaType="com.harusari.chainware.vendor.command.domain.aggregate.VendorType"/>
        <result property="vendorZipcode" column="vendor_zipcode"/>
        <result property="vendorAddressRoad" column="vendor_address_road"/>
        <result property="vendorAddressDetail" column="vendor_address_detail"/>
        <result property="vendorTaxId" column="vendor_tax_id"/>
        <result property="vendorMemo" column="vendor_memo"/>
        <result property="vendorStatus" column="vendor_status" javaType="com.harusari.chainware.vendor.command.domain.aggregate.VendorStatus"/>
        <result property="agreement" column="agreement"/>
        <result property="vendorStartDate" column="vendor_start_date"/>
        <result property="vendorEndDate" column="vendor_end_date"/>
    </resultMap>

    <select id="findVendorDetailById" resultMap="VendorDetailResultMap">
        SELECT
        v.vendor_id,
        v.member_id,
        m.name AS member_name,
        m.phone_number AS member_phone,
        v.vendor_name,
<!--        v.vendor_contact,-->
        v.vendor_type,
        v.vendor_zipcode,
        v.vendor_address_road,
        v.vendor_address_detail,
        v.vendor_tax_id,
        v.vendor_memo,
        v.vendor_status,
<!--        v.agreement,-->
        v.vendor_start_date,
        v.vendor_end_date
        FROM vendor v
        JOIN member m ON v.member_id = m.member_id
        WHERE v.vendor_id = #{vendorId}
    </select>

</mapper>
